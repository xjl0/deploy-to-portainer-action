# –ú–û–î–£–õ–¨–ù–´–ô –®–ê–ë–õ–û–ù - —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–µ jobs –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
# –ö–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ –≤–∞—à —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: .github/workflows/deploy.yml

name: –ú–æ–¥—É–ª—å–Ω—ã–π –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ PR

on:
  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ PR
  pull_request:
    types: [opened, synchronize]
    branches:
      - dev
      - main
  
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≥–æ—Ç–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞
  workflow_dispatch:
    inputs:
      environment:
        description: '–û–∫—Ä—É–∂–µ–Ω–∏–µ (dev/prod)'
        required: true
        type: choice
        options:
          - dev
          - prod
      image_tag:
        description: '–¢–µ–≥ –æ–±—Ä–∞–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: dev-abc1234)'
        required: true
        type: string
      skip_build:
        description: '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä–∫—É (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π –æ–±—Ä–∞–∑)'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io

jobs:
  # Job 1: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  setup:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      env_type: ${{ steps.env.outputs.env_type }}
      image_name: ${{ steps.env.outputs.image_name }}
      image_tag: ${{ steps.env.outputs.image_tag }}
      compose_file: ${{ steps.env.outputs.compose_file }}
      stack_name: ${{ steps.env.outputs.stack_name }}
      stack_id: ${{ steps.env.outputs.stack_id }}
      skip_build: ${{ steps.env.outputs.skip_build }}
      short_sha: ${{ steps.env.outputs.short_sha }}
      # –í–ê–ñ–ù–û: –°–µ–∫—Ä–µ—Ç—ã –Ω–µ–ª—å–∑—è –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —á–µ—Ä–µ–∑ outputs! GitHub –∏—Ö –±–ª–æ–∫–∏—Ä—É–µ—Ç.
      # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ environment —á—Ç–æ–±—ã –≤ deploy –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã

    steps:
      - name: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
        id: env
        run: |
          echo "üîç DEBUG: Event name: ${{ github.event_name }}"
          echo "üîç DEBUG: Base ref: ${{ github.base_ref }}"
          echo "üîç DEBUG: Ref: ${{ github.ref }}"
          
          # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏–º—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ lowercase
          IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          
          # Workflow dispatch (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫)
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
            SKIP_BUILD="${{ github.event.inputs.skip_build }}"
            IMAGE_TAG="${{ github.event.inputs.image_tag }}"
            
            echo "skip_build=${SKIP_BUILD}" >> $GITHUB_OUTPUT
            echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
            echo "short_sha=${IMAGE_TAG##*-}" >> $GITHUB_OUTPUT
            
            if [ "$ENV" == "dev" ]; then
              echo "environment=staging" >> $GITHUB_OUTPUT
              echo "env_type=staging" >> $GITHUB_OUTPUT
              echo "compose_file=docker-compose.dev.yml" >> $GITHUB_OUTPUT
              echo "stack_name=${{ secrets.DEV_STACK_NAME }}" >> $GITHUB_OUTPUT
              echo "stack_id=${{ secrets.DEV_STACK_ID }}" >> $GITHUB_OUTPUT
              echo "portainer_host=${{ secrets.DEV_PORTAINER_HOST }}" >> $GITHUB_OUTPUT
              echo "portainer_api_key=${{ secrets.DEV_PORTAINER_API_KEY }}" >> $GITHUB_OUTPUT
              echo "portainer_endpoint_id=${{ secrets.DEV_PORTAINER_ENDPOINT_ID }}" >> $GITHUB_OUTPUT
            else
              echo "environment=production" >> $GITHUB_OUTPUT
              echo "env_type=production" >> $GITHUB_OUTPUT
              echo "compose_file=docker-compose.prod.yml" >> $GITHUB_OUTPUT
              echo "stack_name=${{ secrets.PROD_STACK_NAME }}" >> $GITHUB_OUTPUT
              echo "stack_id=${{ secrets.PROD_STACK_ID }}" >> $GITHUB_OUTPUT
              echo "portainer_host=${{ secrets.PROD_PORTAINER_HOST }}" >> $GITHUB_OUTPUT
              echo "portainer_api_key=${{ secrets.PROD_PORTAINER_API_KEY }}" >> $GITHUB_OUTPUT
              echo "portainer_endpoint_id=${{ secrets.PROD_PORTAINER_ENDPOINT_ID }}" >> $GITHUB_OUTPUT
            fi
          # Pull Request (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π)
          else
            echo "skip_build=false" >> $GITHUB_OUTPUT
            SHORT_SHA=$(echo "${{ github.event.pull_request.head.sha }}" | cut -c1-7)
            IMAGE_TAG="${{ github.base_ref }}-${SHORT_SHA}"
            echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
            echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
            
            if [ "${{ github.base_ref }}" == "dev" ]; then
              echo "environment=staging" >> $GITHUB_OUTPUT
              echo "env_type=staging" >> $GITHUB_OUTPUT
              echo "compose_file=docker-compose.dev.yml" >> $GITHUB_OUTPUT
              
              echo ""
              echo "üîç DEBUG: –ü—Ä–æ–≤–µ—Ä–∫–∞ DEV —Å–µ–∫—Ä–µ—Ç–æ–≤:"
              echo "  DEV_PORTAINER_HOST: ${{ secrets.DEV_PORTAINER_HOST != '' && '‚úÖ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' || '‚ùå –ù–ï–¢' }}"
              echo "  DEV_PORTAINER_API_KEY: ${{ secrets.DEV_PORTAINER_API_KEY != '' && '‚úÖ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' || '‚ùå –ù–ï–¢' }}"
              echo "  DEV_PORTAINER_ENDPOINT_ID: ${{ secrets.DEV_PORTAINER_ENDPOINT_ID != '' && '‚úÖ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' || '‚ùå –ù–ï–¢' }}"
              echo "  DEV_STACK_NAME: ${{ secrets.DEV_STACK_NAME != '' && '‚úÖ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' || '‚ùå –ù–ï–¢' }}"
              echo "  DEV_STACK_ID: ${{ secrets.DEV_STACK_ID != '' && '‚úÖ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' || '‚ùå –ù–ï–¢' }}"
              echo ""
              
              echo "stack_name=${{ secrets.DEV_STACK_NAME }}" >> $GITHUB_OUTPUT
              echo "stack_id=${{ secrets.DEV_STACK_ID }}" >> $GITHUB_OUTPUT
              echo "portainer_host=${{ secrets.DEV_PORTAINER_HOST }}" >> $GITHUB_OUTPUT
              echo "portainer_api_key=${{ secrets.DEV_PORTAINER_API_KEY }}" >> $GITHUB_OUTPUT
              echo "portainer_endpoint_id=${{ secrets.DEV_PORTAINER_ENDPOINT_ID }}" >> $GITHUB_OUTPUT
            elif [ "${{ github.base_ref }}" == "main" ]; then
              echo "environment=production" >> $GITHUB_OUTPUT
              echo "env_type=production" >> $GITHUB_OUTPUT
              echo "compose_file=docker-compose.prod.yml" >> $GITHUB_OUTPUT
              
              echo ""
              echo "üîç DEBUG: –ü—Ä–æ–≤–µ—Ä–∫–∞ PROD —Å–µ–∫—Ä–µ—Ç–æ–≤:"
              echo "  PROD_PORTAINER_HOST: ${{ secrets.PROD_PORTAINER_HOST != '' && '‚úÖ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' || '‚ùå –ù–ï–¢' }}"
              echo "  PROD_PORTAINER_API_KEY: ${{ secrets.PROD_PORTAINER_API_KEY != '' && '‚úÖ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' || '‚ùå –ù–ï–¢' }}"
              echo "  PROD_PORTAINER_ENDPOINT_ID: ${{ secrets.PROD_PORTAINER_ENDPOINT_ID != '' && '‚úÖ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' || '‚ùå –ù–ï–¢' }}"
              echo "  PROD_STACK_NAME: ${{ secrets.PROD_STACK_NAME != '' && '‚úÖ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' || '‚ùå –ù–ï–¢' }}"
              echo "  PROD_STACK_ID: ${{ secrets.PROD_STACK_ID != '' && '‚úÖ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' || '‚ùå –ù–ï–¢' }}"
              echo ""
              
              echo "stack_name=${{ secrets.PROD_STACK_NAME }}" >> $GITHUB_OUTPUT
              echo "stack_id=${{ secrets.PROD_STACK_ID }}" >> $GITHUB_OUTPUT
              echo "portainer_host=${{ secrets.PROD_PORTAINER_HOST }}" >> $GITHUB_OUTPUT
              echo "portainer_api_key=${{ secrets.PROD_PORTAINER_API_KEY }}" >> $GITHUB_OUTPUT
              echo "portainer_endpoint_id=${{ secrets.PROD_PORTAINER_ENDPOINT_ID }}" >> $GITHUB_OUTPUT
            else
              echo "‚ùå –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –≤–µ—Ç–∫–∞: ${{ github.base_ref }}"
              exit 1
            fi
          fi
          
          echo "‚úÖ –û–∫—Ä—É–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"
          echo ""
          echo "üìã Outputs:"
          cat $GITHUB_OUTPUT
          echo ""

  # Job 2: –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ (–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –µ—Å–ª–∏ skip_build=true)
  build:
    needs: setup
    if: needs.setup.outputs.skip_build != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞
        uses: actions/checkout@v4

      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: –í—Ö–æ–¥ –≤ GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: –°–±–æ—Ä–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—Ä–∞–∑–∞
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ needs.setup.outputs.image_name }}:${{ needs.setup.outputs.image_tag }}
            ${{ env.REGISTRY }}/${{ needs.setup.outputs.image_name }}:${{ needs.setup.outputs.environment }}-latest
          build-args: |
            ENV_TYPE=${{ needs.setup.outputs.env_type }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ–±—Ä–∞–∑–µ
        run: |
          echo "‚úÖ –û–±—Ä–∞–∑ —Å–æ–±—Ä–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω:"
          echo "üì¶ ${{ env.REGISTRY }}/${{ needs.setup.outputs.image_name }}:${{ needs.setup.outputs.image_tag }}"

  # Job 3: –î–µ–ø–ª–æ–π –≤ Portainer (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç setup, –∂–¥—ë—Ç build –µ—Å–ª–∏ –æ–Ω –±—ã–ª)
  deploy:
    needs: [setup, build]
    if: always() && needs.setup.result == 'success' && (needs.build.result == 'success' || needs.build.result == 'skipped')
    runs-on: ubuntu-latest

    steps:
      - name: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ –ø–æ –æ–∫—Ä—É–∂–µ–Ω–∏—é
        id: secrets
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          echo "üîç –û–∫—Ä—É–∂–µ–Ω–∏–µ: $ENV"
          
          if [ "$ENV" == "staging" ]; then
            echo "portainer_host=${{ secrets.DEV_PORTAINER_HOST }}" >> $GITHUB_OUTPUT
            echo "portainer_api_key=${{ secrets.DEV_PORTAINER_API_KEY }}" >> $GITHUB_OUTPUT
            echo "portainer_endpoint_id=${{ secrets.DEV_PORTAINER_ENDPOINT_ID }}" >> $GITHUB_OUTPUT
          else
            echo "portainer_host=${{ secrets.PROD_PORTAINER_HOST }}" >> $GITHUB_OUTPUT
            echo "portainer_api_key=${{ secrets.PROD_PORTAINER_API_KEY }}" >> $GITHUB_OUTPUT
            echo "portainer_endpoint_id=${{ secrets.PROD_PORTAINER_ENDPOINT_ID }}" >> $GITHUB_OUTPUT
          fi
          
          echo "‚úÖ –°–µ–∫—Ä–µ—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–ª—è $ENV"

      - name: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞ (–¥–ª—è docker-compose —Ñ–∞–π–ª–æ–≤)
        uses: actions/checkout@v4

      - name: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ Portainer
        uses: xjl0/deploy-to-portainer-action@v1
        with:
          portainer-host: ${{ steps.secrets.outputs.portainer_host }}
          api-key: ${{ steps.secrets.outputs.portainer_api_key }}
          endpoint-id: ${{ steps.secrets.outputs.portainer_endpoint_id }}
          stack-name: ${{ needs.setup.outputs.stack_name }}
          stack-id: ${{ needs.setup.outputs.stack_id }}
          stack-definition: ${{ needs.setup.outputs.compose_file }}
          image: ${{ env.REGISTRY }}/${{ needs.setup.outputs.image_name }}:${{ needs.setup.outputs.image_tag }}
          pullImage: true
          prune: true

      - name: –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        run: |
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!"
          echo "üåç –û–∫—Ä—É–∂–µ–Ω–∏–µ: ${{ needs.setup.outputs.environment }}"
          echo "üì¶ –û–±—Ä–∞–∑: ${{ env.REGISTRY }}/${{ needs.setup.outputs.image_name }}:${{ needs.setup.outputs.image_tag }}"

  # Job 4: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ PR (—Ç–æ–ª—å–∫–æ –¥–ª—è PR, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç deploy)
  comment:
    needs: [setup, deploy]
    if: github.event_name == 'pull_request' && always() && needs.setup.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–± —É—Å–ø–µ—Ö–µ
        if: needs.deploy.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `### ‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
            
            **–û–∫—Ä—É–∂–µ–Ω–∏–µ:** \`${{ needs.setup.outputs.environment }}\`
            **ENV_TYPE:** \`${{ needs.setup.outputs.env_type }}\`
            **–û–±—Ä–∞–∑:** \`${{ env.REGISTRY }}/${{ needs.setup.outputs.image_name }}:${{ needs.setup.outputs.image_tag }}\`
            **–°—Ç–µ–∫:** \`${{ needs.setup.outputs.stack_name || needs.setup.outputs.stack_id }}\`
            **Commit:** \`${{ needs.setup.outputs.short_sha }}\`
            
            –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ –≤ Portainer.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–± –æ—à–∏–±–∫–µ
        if: needs.deploy.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `### ‚õîÔ∏è –û—à–∏–±–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
            
            **–û–∫—Ä—É–∂–µ–Ω–∏–µ:** \`${{ needs.setup.outputs.environment }}\`
            **ENV_TYPE:** \`${{ needs.setup.outputs.env_type }}\`
            **Commit:** \`${{ needs.setup.outputs.short_sha }}\`
            
            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ workflow –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
