# ШАБЛОН для использования в вашем проекте
# Скопируйте этот файл в ваш репозиторий: .github/workflows/deploy.yml

name: Сборка и развертывание через Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - dev   # staging/test окружение
      - main  # production окружение

env:
  REGISTRY: ghcr.io

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      pull-requests: write

    steps:
      # 1. Определяем окружение на основе целевой ветки
      - name: Определение окружения
        id: env
        run: |
          # Преобразуем имя репозитория в lowercase для Docker (ghcr.io требует lowercase)
          IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          
          if [ "${{ github.base_ref }}" == "dev" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "env_type=staging" >> $GITHUB_OUTPUT
            echo "stack_name=${{ secrets.DEV_STACK_NAME }}" >> $GITHUB_OUTPUT
            echo "compose_file=docker-compose.dev.yml" >> $GITHUB_OUTPUT
            echo "portainer_host=${{ secrets.DEV_PORTAINER_HOST }}" >> $GITHUB_OUTPUT
            echo "portainer_api_key=${{ secrets.DEV_PORTAINER_API_KEY }}" >> $GITHUB_OUTPUT
            echo "portainer_endpoint_id=${{ secrets.DEV_PORTAINER_ENDPOINT_ID }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.base_ref }}" == "main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "env_type=production" >> $GITHUB_OUTPUT
            echo "stack_name=${{ secrets.PROD_STACK_NAME }}" >> $GITHUB_OUTPUT
            echo "compose_file=docker-compose.prod.yml" >> $GITHUB_OUTPUT
            echo "portainer_host=${{ secrets.PROD_PORTAINER_HOST }}" >> $GITHUB_OUTPUT
            echo "portainer_api_key=${{ secrets.PROD_PORTAINER_API_KEY }}" >> $GITHUB_OUTPUT
            echo "portainer_endpoint_id=${{ secrets.PROD_PORTAINER_ENDPOINT_ID }}" >> $GITHUB_OUTPUT
          fi
          
          # Генерация тега образа
          SHORT_SHA=$(echo "${{ github.event.pull_request.head.sha }}" | cut -c1-7)
          IMAGE_TAG="${{ github.base_ref }}-${SHORT_SHA}"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      # 2. Получение кода
      - name: Получение кода
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      # 3. Настройка Docker Buildx
      - name: Настройка Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 4. Вход в Container Registry
      - name: Вход в GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 5. Сборка и отправка Docker образа
      - name: Сборка и отправка образа
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ steps.env.outputs.image_name }}:${{ steps.env.outputs.image_tag }}
            ${{ env.REGISTRY }}/${{ steps.env.outputs.image_name }}:${{ github.base_ref }}-latest
          labels: |
            org.opencontainers.image.source=${{ github.event.repository.html_url }}
            org.opencontainers.image.revision=${{ github.event.pull_request.head.sha }}
            org.opencontainers.image.created=${{ github.event.pull_request.updated_at }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            ENV_TYPE=${{ steps.env.outputs.env_type }}

      # 6. Развертывание в Portainer
      - name: Развертывание в Portainer (${{ steps.env.outputs.environment }})
        uses: xjl0/deploy-to-portainer-action@v1
        with:
          portainer-host: ${{ steps.env.outputs.portainer_host }}
          api-key: ${{ steps.env.outputs.portainer_api_key }}
          endpoint-id: ${{ steps.env.outputs.portainer_endpoint_id }}
          stack-name: ${{ steps.env.outputs.stack_name }}
          stack-definition: ${{ steps.env.outputs.compose_file }}
          image: ${{ env.REGISTRY }}/${{ steps.env.outputs.image_name }}:${{ steps.env.outputs.image_tag }}
          pullImage: true
          prune: true

      # 7. Комментарий в PR с информацией о деплое
      - name: Добавление комментария в PR
        uses: actions/github-script@v7
        if: success()
        with:
          script: |
            const output = `### ✅ Развертывание успешно завершено
            
            **Окружение:** \`${{ steps.env.outputs.environment }}\`
            **ENV_TYPE:** \`${{ steps.env.outputs.env_type }}\`
            **Образ:** \`${{ env.REGISTRY }}/${{ steps.env.outputs.image_name }}:${{ steps.env.outputs.image_tag }}\`
            **Стек:** \`${{ steps.env.outputs.stack_name }}\`
            **Commit:** \`${{ steps.env.outputs.short_sha }}\`
            
            Приложение развернуто и доступно в Portainer.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      # 8. Комментарий в PR при ошибке
      - name: Комментарий об ошибке
        uses: actions/github-script@v7
        if: failure()
        with:
          script: |
            const output = `### ⛔️ Ошибка развертывания
            
            **Окружение:** \`${{ steps.env.outputs.environment }}\`
            **ENV_TYPE:** \`${{ steps.env.outputs.env_type }}\`
            **Commit:** \`${{ steps.env.outputs.short_sha }}\`
            
            Проверьте логи workflow для деталей.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
