# –®–ê–ë–õ–û–ù –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ –≤–∞—à —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: .github/workflows/deploy.yml

name: –°–±–æ—Ä–∫–∞ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - dev   # staging/test –æ–∫—Ä—É–∂–µ–Ω–∏–µ
      - main  # production –æ–∫—Ä—É–∂–µ–Ω–∏–µ

env:
  REGISTRY: ghcr.io

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      pull-requests: write

    steps:
      # 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ü–µ–ª–µ–≤–æ–π –≤–µ—Ç–∫–∏
      - name: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
        id: env
        run: |
          echo "üîç –¶–µ–ª–µ–≤–∞—è –≤–µ—Ç–∫–∞ PR (base_ref): ${{ github.base_ref }}"
          echo "üì¶ –ò—Å—Ö–æ–¥–Ω–∞—è –≤–µ—Ç–∫–∞ PR (head_ref): ${{ github.head_ref }}"
          
          # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏–º—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ lowercase –¥–ª—è Docker (ghcr.io —Ç—Ä–µ–±—É–µ—Ç lowercase)
          IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          
          if [ "${{ github.base_ref }}" == "dev" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "env_type=staging" >> $GITHUB_OUTPUT
            echo "stack_name=${{ secrets.DEV_STACK_NAME }}" >> $GITHUB_OUTPUT
            echo "compose_file=docker-compose.dev.yml" >> $GITHUB_OUTPUT
            echo "portainer_host=${{ secrets.DEV_PORTAINER_HOST }}" >> $GITHUB_OUTPUT
            echo "portainer_api_key=${{ secrets.DEV_PORTAINER_API_KEY }}" >> $GITHUB_OUTPUT
            echo "portainer_endpoint_id=${{ secrets.DEV_PORTAINER_ENDPOINT_ID }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.base_ref }}" == "main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "env_type=production" >> $GITHUB_OUTPUT
            echo "stack_name=${{ secrets.PROD_STACK_NAME }}" >> $GITHUB_OUTPUT
            echo "compose_file=docker-compose.prod.yml" >> $GITHUB_OUTPUT
            echo "portainer_host=${{ secrets.PROD_PORTAINER_HOST }}" >> $GITHUB_OUTPUT
            echo "portainer_api_key=${{ secrets.PROD_PORTAINER_API_KEY }}" >> $GITHUB_OUTPUT
            echo "portainer_endpoint_id=${{ secrets.PROD_PORTAINER_ENDPOINT_ID }}" >> $GITHUB_OUTPUT
          else
            echo "‚ùå –û–®–ò–ë–ö–ê: –¶–µ–ª–µ–≤–∞—è –≤–µ—Ç–∫–∞ '${{ github.base_ref }}' –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è!"
            echo "   –û–∂–∏–¥–∞–µ—Ç—Å—è 'dev' –∏–ª–∏ 'main'"
            exit 1
          fi
          
          # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–≥–∞ –æ–±—Ä–∞–∑–∞
          SHORT_SHA=$(echo "${{ github.event.pull_request.head.sha }}" | cut -c1-7)
          IMAGE_TAG="${{ github.base_ref }}-${SHORT_SHA}"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          
          echo "‚úÖ –û–∫—Ä—É–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ"

      # 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞
      - name: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      # 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx
      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 4. –í—Ö–æ–¥ –≤ Container Registry
      - name: –í—Ö–æ–¥ –≤ GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 5. –°–±–æ—Ä–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ Docker –æ–±—Ä–∞–∑–∞
      - name: –°–±–æ—Ä–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—Ä–∞–∑–∞
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ steps.env.outputs.image_name }}:${{ steps.env.outputs.image_tag }}
            ${{ env.REGISTRY }}/${{ steps.env.outputs.image_name }}:${{ github.base_ref }}-latest
          labels: |
            org.opencontainers.image.source=${{ github.event.repository.html_url }}
            org.opencontainers.image.revision=${{ github.event.pull_request.head.sha }}
            org.opencontainers.image.created=${{ github.event.pull_request.updated_at }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            ENV_TYPE=${{ steps.env.outputs.env_type }}

      # 6. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ Portainer
      - name: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ Portainer (${{ steps.env.outputs.environment }})
        uses: xjl0/deploy-to-portainer-action@v1
        with:
          portainer-host: ${{ steps.env.outputs.portainer_host }}
          api-key: ${{ steps.env.outputs.portainer_api_key }}
          endpoint-id: ${{ steps.env.outputs.portainer_endpoint_id }}
          stack-name: ${{ steps.env.outputs.stack_name }}
          stack-definition: ${{ steps.env.outputs.compose_file }}
          image: ${{ env.REGISTRY }}/${{ steps.env.outputs.image_name }}:${{ steps.env.outputs.image_tag }}
          pullImage: true
          prune: true

      # 7. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ PR —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –¥–µ–ø–ª–æ–µ
      - name: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –≤ PR
        uses: actions/github-script@v7
        if: success()
        with:
          script: |
            const output = `### ‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
            
            **–û–∫—Ä—É–∂–µ–Ω–∏–µ:** \`${{ steps.env.outputs.environment }}\`
            **ENV_TYPE:** \`${{ steps.env.outputs.env_type }}\`
            **–û–±—Ä–∞–∑:** \`${{ env.REGISTRY }}/${{ steps.env.outputs.image_name }}:${{ steps.env.outputs.image_tag }}\`
            **–°—Ç–µ–∫:** \`${{ steps.env.outputs.stack_name }}\`
            **Commit:** \`${{ steps.env.outputs.short_sha }}\`
            
            –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ –≤ Portainer.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      # 8. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ PR –ø—Ä–∏ –æ—à–∏–±–∫–µ
      - name: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–± –æ—à–∏–±–∫–µ
        uses: actions/github-script@v7
        if: failure()
        with:
          script: |
            const output = `### ‚õîÔ∏è –û—à–∏–±–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
            
            **–û–∫—Ä—É–∂–µ–Ω–∏–µ:** \`${{ steps.env.outputs.environment }}\`
            **ENV_TYPE:** \`${{ steps.env.outputs.env_type }}\`
            **Commit:** \`${{ steps.env.outputs.short_sha }}\`
            
            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ workflow –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
